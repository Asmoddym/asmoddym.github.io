package net.noparking.projects.activity

import android.arch.lifecycle.LiveData
import android.arch.lifecycle.Observer
import android.content.Intent
import android.graphics.Color
import android.support.v7.app.AppCompatActivity
import android.os.Bundle
import android.support.v7.app.AlertDialog
import android.util.Log
import android.view.View
import android.view.Window
import android.view.WindowManager
import android.widget.LinearLayout

import kotlinx.android.synthetic.main.activity_projects_manager.*
import kotlinx.android.synthetic.main.layout_project_description.view.*
import net.noparking.projects.R
import net.noparking.projects.adapter.LinearLayoutAdapter
import net.noparking.projects.database.image.ImagesCollector
import net.noparking.projects.database.project.Project
import net.noparking.projects.database.project.ProjectAsyncDelete
import net.noparking.projects.database.project.ProjectAsyncInsert
import net.noparking.projects.database.project.ProjectsCollector
import net.noparking.projects.utl.ProjectItemParametring
import net.noparking.projects.utl.ProjectNamePicker
import java.text.SimpleDateFormat
import java.util.*
import kotlin.collections.ArrayList

class ProjectsManagerActivity : AppCompatActivity() {
	private lateinit var _projects_list: LiveData<List<Project>>

	override fun onCreate(savedInstanceState: Bundle?) {
		super.onCreate(savedInstanceState)

		requestWindowFeature(Window.FEATURE_NO_TITLE)
		this.window.setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN, WindowManager.LayoutParams.FLAG_FULLSCREEN)

		setContentView(R.layout.activity_projects_manager)


		_projects_list = ProjectsCollector().init(baseContext).getAll()

		initNewProjectButton()
		initProjectsView()
	}

	private fun initNewProjectButton() {
		projects_manager_new_project.setOnClickListener {
			ProjectItemParametring(this)
					.setDefaultInput("")
					.setComparisonMethod { input -> compareProjectNames(input) }
					.setOnSaveAction { name, color -> createNewProject(name, color) }
					.show()
		}
	}

	private fun initProjectsView() {
		_projects_list.observe(this, Observer {projects ->
			if (projects != null && projects.isNotEmpty()) {
				projects_manager_projects_list.visibility = View.VISIBLE
				projects_manager_no_projects.visibility = View.GONE

				val array: ArrayList<LinearLayout> = arrayListOf()
				val images = ImagesCollector().init(baseContext)
				projects.forEach {project ->
					val layout = layoutInflater.inflate(R.layout.layout_project_description, null) as LinearLayout
					layout.layout_project_description_project_name.text = project.project_name
					layout.setOnClickListener { goToProjectManager(project.id) }
					layout.setOnLongClickListener { goToProjectParametring(project); true }

					images.getByProjectId(project.id!!).observe(this, Observer {
						layout.layout_project_description_images_number.text = when (it != null && it.isNotEmpty()) {
							true -> it!!.size.toString()
							else -> "0"
						}
					})
					array.add(layout)
				}
				projects_manager_projects_list.adapter = LinearLayoutAdapter(baseContext, array)
			} else {
				projects_manager_projects_list.visibility = View.GONE
				projects_manager_no_projects.visibility = View.VISIBLE
			}
		})
	}

	private fun compareProjectNames(name: String): Boolean {
		_projects_list.value!!.forEach {
			if (it.project_name == name) {
				return true
			}
		}
		return false
	}

	private fun goToProjectParametring(project: Project) {
		val param = ProjectItemParametring(this)
		param.setDefaultInput(project.project_name)
				.setDefaultColor(project.color)
				.setComparisonMethod { name -> compareProjectNames(name) }
				.setOnSaveAction { name, color ->
					project.project_name = name
					project.color = color
					ProjectAsyncInsert().init(baseContext).execute(project) }
				.setOnDeleteAction { deleteProject(project) }
				.show()
	}

	private fun deleteProject(project: Project) {



//		ProjectAsyncDelete().init(baseContext).deleteById(project.id!!).execute()
	}

	private fun createNewProject(name: String, color: Int) {
		val project = Project()
		project.directory = generateDirectoryFromProjectName(name)
		project.project_name = name
		project.color = color
		ProjectAsyncInsert().init(baseContext).afterQuery { goToProjectManager(it) }.execute(project)
	}

	private fun goToProjectManager(project_id: Long?) {
		val intent = Intent(this, ProjectManagerActivity::class.java)
		intent.putExtra("project_id", project_id)
		startActivity(intent)
	}

	private fun generateDirectoryFromProjectName(raw: String): String {
		val result = raw.toLowerCase().replace(' ', '_')
		return result + "_" + SimpleDateFormat("yyyyMMdd_HHmmss").format(Date())
	}

	override fun onDestroy() {
		super.onDestroy()
	}
}