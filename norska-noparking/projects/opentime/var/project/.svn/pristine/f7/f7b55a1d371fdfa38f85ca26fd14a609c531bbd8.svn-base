<?php
/*
	opentime
	$Author$
	$URL$
	$Revision$

	Copyright (C) No Parking 2015 - 2018
*/

class Navigation_Tree_Genova extends Navigation_Tree_Default {
	function create_branches() {
		$this->tree = array();
		
		if (isset($this->authenticated)) {
			if ($this->authenticated instanceof Contact_Authenticated) {
				$this->tree['guest'] = array(
					'name' => __("guest access"),
					'selected' => "",
				);
			} elseif ($this->authenticated instanceof User_Authenticated) {
				$this->tree['scoreboard'] = array(
					'name' => "<img src=\"".$GLOBALS['config']['layout_mediaserver']."medias/images/genova/home.png\" />",
				);
				if ($GLOBALS['param']['ext_time']) {
					$this->tree['time'] = array(
						'name' => __("time"),
					);
				}
				if ($GLOBALS['param']['ext_requests'] or $GLOBALS['param']['ext_chargeplan'] or $GLOBALS['param']['ext_planning']) {
					$this->tree['projectmanagement'] = array(
						'name' => __("project management"),
					);
				}
				if ($GLOBALS['param']['ext_finances']) {
					$this->tree['finances'] = array(
						'name' => __("finances"),
					);
				}
				if ($GLOBALS['param']['ext_absences'] or $GLOBALS['param']['ext_holidays']) {
					$this->tree['humanressources'] = array(
						'name' => __("human ressources").$this->notification_for_human_ressources(),
					);
				}
				if ($GLOBALS['param']['ext_report']) {
					$this->tree['report'] = array(
						'name' => $GLOBALS['txt_reports'],
					);
				}
				if ($this->authenticated->is_admin()) {
					$this->tree['configuration'] = array(
						'name' => $GLOBALS['txt_configuration'],
					);
				}
			}
		}
		
		return $this;
	}

	function notification_count_for_personal_requests() {
		if (isset($this->authenticated) and $this->authenticated instanceof User_Authenticated and $this->authenticated->is_admin()) {
			$statuses = new Personal_Request_Statuses();
			$statuses->select();
				
			$personalrequests = new Personal_Requests();
			$personalrequests->requeststatus_id = $statuses->ids_to_be_validated_or_refused();
			if (!$this->authenticated->is_root()) {
				$personalrequests->user_id = $this->authenticated->team_ids();
			}
			$personalrequests->select();
			return count($personalrequests);
		} else {
			return 0;
		}
	}

	function notification_for_personal_requests() {
		return Format::notification($this->notification_count_for_personal_requests());
	}

	function notification_for_human_ressources() {
		return Format::notification($this->notification_count_for_personal_requests());
	}
	
	function add_leaves_on_branch($key) {
		switch ($key) {
			case "scoreboard":
				return $this->add_leaves_on_scoreboard();
			case "time":
				return $this->add_leaves_on_time();
			case "projectmanagement":
				return $this->add_leaves_on_projectmanagement();
			case "finances":
				return $this->add_leaves_on_finances();
			case "humanressources":
				return $this->add_leaves_on_humanressources();
			case "report":
				return $this->add_leaves_on_report();
			case "configuration":
				return $this->add_leaves_on_configuration();
			case "guest":
				return $this->add_leaves_on_guest();
			default:
				return array();
		}
	}
	
	function add_leaves_on_scoreboard() {
		$leaves = array();
		if (isset($GLOBALS['authenticated_user']) and $GLOBALS['authenticated_user']->has_at_least_access($GLOBALS['param']['permissions_managereports'])) {
			$leaves['reportscoreboard.php'] = array(
				'name' => __("scoreboard"),
				'link' => "reportscoreboard.php",
				'selected' => ($this->content == "reportscoreboard.php") ? "selected" : "",
			);
		}
		$this->tree['scoreboard']['leaves'] = $leaves;
		return $this;
	}

	function add_leaves_on_time() {
		$leaves = array(
			'time.php' => array(
				'name' => __("time"),
				'link' => "time.php",
				'selected' => ($this->content == "time.php") ? "selected" : "",
			)
		);
		$this->tree['time']['leaves'] = $leaves;
		return $this;
	}

	function add_leaves_on_projectmanagement() {
		$leaves = array();
		if ($GLOBALS['param']['ext_requests']) {
			$leaves['requests.php'] = array(
				'name' => $GLOBALS['param']['requests'],
				'link' => "requests.php",
				'selected' => in_array($this->content, array("requests.php", "request.php")) ? "selected" : "",
			);
		}
		if ($GLOBALS['param']['ext_chargeplan']) {
			$leaves['workloads.php'] = array(
				'name' => $GLOBALS['txt_chargeplan'],
				'link' => "workloads.php",
				'selected' => ($this->content == "workloads.php") ? "selected" : "",
			);
		}
		if ($GLOBALS['param']['ext_calendar']) {
			$leaves['calendar.php'] = array(
				'name' => $GLOBALS['txt_calendar'],
				'link' => "calendar.php",
				'selected' => in_array($this->content, array("calendar.php", "userevent.php")) ? "selected" : "",
			);
		}
		if ($GLOBALS['param']['ext_contacts']) {
			$leaves['contacts.php'] = array(
				'name' => $GLOBALS['txt_contacts'],
				'link' => "contacts.php",
				'selected' => in_array($this->content, array("contacts.php", "contact.php", "contactaccess.php")) ? "selected" : "",
			);
		}
		if ($GLOBALS['param']['ext_estimates']) {
			$leaves['projectestimates.php'] = array(
				'name' => $GLOBALS['txt_estimates'],
				'link' => "projectestimates.php",
				'selected' => ($this->content == "projectestimates.php") ? "selected" : "",
			);
			$leaves['projectdetails.php'] = array(
				'name' => $GLOBALS['txt_details'],
				'link' => "projectdetails.php",
				'selected' => ($this->content == "projectdetails.php") ? "selected" : "",
			);
		}
		$this->tree['projectmanagement']['leaves'] = $leaves;
		return $this;
	}
	
	function add_leaves_on_finances() {
		$leaves = array();
		if ($GLOBALS['param']['ext_quotes']) {
			$leaves['quotes.php'] = array(
				'name' => $GLOBALS['txt_quotes'],
				'link' => "quotes.php",
				'selected' => ($this->content == "quotes.php") ? "selected" : "",
			);
		}
		if ($GLOBALS['param']['ext_invoices']) {
			$leaves['invoices.php'] = array(
				'name' => $GLOBALS['txt_invoices'],
				'link' => "invoices.php",
				'selected' => ($this->content == "invoices.php" || $this->content == "invoice.php") ? "selected" : "",
			);
		}
		if ($GLOBALS['param']['ext_finances']) {
			$leaves['purchases.php'] = array(
				'name' => __("purchases"),
				'link' => "purchases.php",
				'selected' => ($this->content == "purchases.php") ? "selected" : "",
			);
			$leaves['salefigures.php'] = array(
				'name' => __("sales"),
				'link' => "salefigures.php",
				'selected' => ($this->content == "salefigures.php") ? "selected" : "",
			);
		}
		if ($GLOBALS['param']['ext_taxrefund']) {
			$leaves['followuptaxrefund.php'] = array(
				'name' => $GLOBALS['txt_taxrefund'],
				'link' => "followuptaxrefund.php",
				'selected' => ($this->content == "followuptaxrefund.php") ? "selected" : "",
			);
		}
		$this->tree['finances']['leaves'] = $leaves;
		return $this;
	}
	
	function add_leaves_on_humanressources() {
		$leaves = array();
		if ($GLOBALS['param']['ext_holidays']) {
			$leaves['personalrequests.php'] = array(
				'name' => __("personal requests").$this->notification_for_personal_requests(),
				'link' => "personalrequests.php",
				'selected' => $this->content == "personalrequests.php" ? "selected" : "",
			);
			$leaves['absenceboard.php'] = array(
				'name' => $GLOBALS['txt_synthesis'],
				'link' => "absenceboard.php",
				'selected' => $this->content == "absenceboard.php" ? "selected" : "",
			);
			$leaves['absencefeedback.php'] = array(
				'name' => $GLOBALS['param']['feedback'],
				'link' => "absencefeedback.php",
				'selected' => $this->content == "absencefeedback.php" ? "selected" : "",
			);
			if ($this->authenticated->is_root_for_absences()) {
				$leaves['absencebalance.php'] = array(
					'name' => $GLOBALS['txt_balance'],
					'link' => "absencebalance.php",
					'title' => $GLOBALS['status_consultbalanceof']." ".$GLOBALS['param']['users'],
					'selected' => $this->content == "absencebalance.php" ? "selected" : "",
				);
			}
			$leaves['absenceadmin.php'] = array(
				'name' => $GLOBALS['txt_detail'],
				'link' => "absenceadmin.php",
				'selected' => $this->content == "absenceadmin.php" ? "selected" : "",
			);
			if ($GLOBALS['param']['ext_absencecredit']) {
				$leaves['absencecredits.php'] = array(
					'name' => $GLOBALS['txt_absencecredit'],
					'link' => "absencecredits.php",
					'title' => "",
					'selected' => $this->content == "absencecredits.php" ? "selected" : "",
				);
			}
			if ($this->authenticated->is_root_for_absences() and $GLOBALS['param']['ext_payrollelements']) {
				$leaves['absencepayrollelements.php'] = array(
					'name' => __("payroll elements"),
					'link' => "absencepayrollelements.php",
					'title' => "",
					'selected' => $this->content == "absencepayrollelements.php" ? "selected" : "",
				);
			}
			if ($GLOBALS['param']['ext_expenses']) {
				$leaves['followupexpenses.php'] = array(
					'name' => $GLOBALS['txt_expenses'],
					'link' => "followupexpenses.php",
					'selected' => ($this->content == "followupexpenses.php") ? "selected" : "",
				);
			}
			if ($GLOBALS['param']['ext_timeannual']) {
				$leaves['followupannualtransfer.php'] = array(
					'name' => __("annualization"),
					'link' => "followupannualtransfer.php",
					'selected' => ($this->content == "followupannualtransfer.php") ? "selected" : "",
				);
			}
			if ($GLOBALS['param']['ext_time']) {
				$leaves['followupreminder.php'] = array(
					'name' => $GLOBALS['txt_reminder'],
					'link' => "followupreminder.php",
					'selected' => ($this->content == "followupreminder.php") ? "selected" : "",
				);
			}
		}
		$this->tree['humanressources']['leaves'] = $leaves;
		return $this;
	}
	
	function add_leaves_on_report() {
		$leaves = array();
		if ($GLOBALS['param']['ext_userfeedback']) {
			$leaves['userfeedback.php'] = array(
				'name' => $GLOBALS['param']['feedback'],
				'link' => "userfeedback.php",
				'selected' => ($this->content == "userfeedback.php") ? "selected" : "",
			);
		}
		if (!isset($this->authenticated) or ($this->authenticated instanceof User_Authenticated and $this->authenticated->has_at_least_access($GLOBALS['param']['permissions_managereports']))) {
			$leaves['reports.php'] = array(
				'name' => $GLOBALS['txt_report'],
				'link' => "reports.php",
				'title' => "",
				'selected' => ($this->content == "reports.php") ? "selected" : "",
			);
			if ($GLOBALS['param']['report_synthesis']){
				$leaves['reportsynthesis.php'] = array(
					'name' => $GLOBALS['txt_synthesis'],
					'link' => "reportsynthesis.php",
					'title' => "",
					'selected' => ($this->content == "reportsynthesis.php") ? "selected" : "",
				);
			}
			if ($GLOBALS['param']['report_excel']){
				$leaves['reportexcel.php'] = array(
					'name' => $GLOBALS['txt_excelexport'],
					'link' => "reportexcel.php",
					'title' => "",
					'selected' => ($this->content == "reportexcel.php") ? "selected" : "",
				);
			}
			if ($GLOBALS['param']['report_analysis']) {
				$leaves['reportanalysis.php'] = array(
					'name' => $GLOBALS['txt_analysis'],
					'link' => "reportanalysis.php",
					'title' => "",
					'selected' => ($this->content == "reportanalysis.php") ? "selected" : "",
				);
			}
			if ($GLOBALS['param']['report_userboard']){
				$leaves['reportuserboard.php'] = array(
					'name' => __("%s validation", array($GLOBALS['param']['users'])),
					'link' => "reportuserboard.php",
					'title' => "",
					'selected' => ($this->content == "reportuserboard.php") ? "selected" : "",
				);
			}
		}
		$this->tree['report']['leaves'] = $leaves;
		return $this;
	}
	
	function add_leaves_on_configuration() {
		$leaves = array();
		if ($this->authenticated->has_at_least_access($GLOBALS['param']['permissions_adduser'])) {
			$leaves['users.php'] = array(
				'name' => $GLOBALS['param']['users'],
				'link' => "users.php",
				'selected' => ($this->content == "users.php" or $this->content == "userassignment.php") ? "selected" : "",
			);
		}
		if ($GLOBALS['param']['ext_activities']) {
			if ($this->authenticated->has_access_to_customers()) {
				$leaves['customers.php'] = array(
					'name' => $GLOBALS['param']['levels_0'],
					'link' => "customers.php",
					'selected' => ($this->content == "customers.php") ? "selected" : "",
				);
			}
			if ($this->authenticated->has_access_to_projects()) {
				$leaves['projects.php'] = array(
					'name' => $GLOBALS['param']['levels_1'],
					'link' => "projects.php",
					'selected' => ($this->content == "projects.php") ? "selected" : "",
				);
			}
		}
		if ($this->authenticated->is_root()) {
			if ($GLOBALS['param']['ext_time'] or $GLOBALS['param']['ext_timekeeper']) {
				$leaves['configbankholidays.php'] = array(
					'name' => $GLOBALS['txt_bankholidays'],
					'link' => "configbankholidays.php",
					'title' => "",
					'selected' => ($this->content == "configbankholidays.php") ? "selected" : "",
				);
			}
			if ($GLOBALS['param']['ext_absences'] or $GLOBALS['param']['ext_holidays']) {
				$leaves['configabsences.php'] = array(
					'name' => $GLOBALS['txt_absences'],
					'link' => "configabsences.php",
					'title' => "",
					'selected' => ($this->content == "configabsences.php") ? "selected" : "",
				);
			}
			if ($GLOBALS['param']['ext_contacts']) {
				$leaves['configcontacts.php'] = array(
					'name' => $GLOBALS['txt_contacts'],
					'link' => "configcontacts.php",
					'title' => $GLOBALS['status_modifyoptionsof']." ".$GLOBALS['txt_contacts'],
					'selected' =>($this->content == "configcontacts.php") ? "selected" : "",
				);
			}
			if ($GLOBALS['param']['ext_finances'] or $GLOBALS['param']['ext_estimates']) {
				$leaves['configratestask.php'] = array(
					'name' => __("cost per %s", array($GLOBALS['param']['task'])),
					'link' => "configratestask.php",
					'title' => "",
					'selected' => ($this->content == "configratestask.php") ? "selected" : "",
				);
			}
			if ($GLOBALS['param']['ext_finances'] and $GLOBALS['param']['cost_rateuser'] and in_array($this->authenticated->id, input_list_2_array($GLOBALS['param']['authorizations_managelabordetails']))) {
				$leaves['configratesuser.php'] = array(
					'name' => __("cost per %s", array($GLOBALS['param']['user'])),
					'link' => "configratesuser.php",
					'title' => "",
					'selected' => ($this->content == "configratesuser.php") ? "selected" : "",
				);
			}
			if ($GLOBALS['param']['ext_expenses']) {
				$leaves['configexpenserates.php'] = array(
					'name' => $GLOBALS['txt_expenses'],
					'link' => "configexpenserates.php",
					'title' => "",
					'selected' => ($this->content == "configexpenserates.php") ? "selected" : "",
				);
			}
			if ($GLOBALS['param']['ext_requests']) {
				$leaves['configrequests.php'] = array(
					'name' => $GLOBALS['param']['requests'],
					'link' => "configrequests.php",
					'title' => "",
					'selected' => ($this->content == "configrequests.php") ? "selected" : "",
				);
			}
			if ($GLOBALS['param']['ext_currencies']) {
				$leaves['configcurrencies.php'] = array(
					'name' => __("currencies"),
					'link' => "configcurrencies.php",
					'title' => "",
					'selected' => ($this->content == "configcurrencies.php") ? "selected" : "",
				);
			}
			$leaves['configoptions.php'] = array(
				'name' => $GLOBALS['txt_options'],
				'link' => "configoptions.php",
				'title' => "",
				'selected' => ($this->content == "configoptions.php") ? "selected" : "",
			);
			$leaves['configparametrizing.php'] = array(
				'name' => $GLOBALS['txt_parametrizing'],
				'link' => "configparametrizing.php",
				'title' => "",
				'selected' => ($this->content == "configparametrizing.php") ? "selected" : "",
			);
		}
		$this->tree['configuration']['leaves'] = $leaves;
		return $this;
	}
}
